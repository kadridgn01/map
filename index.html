<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Navigasyon Sim</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#0b0e14" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html,body{margin:0;height:100%;background:#0b0e14;font:15px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif}
  #map{position:absolute;inset:0}
  .leaflet-container{background:#0b0e14}

  /* √úST TALƒ∞MAT ≈ûERƒ∞Dƒ∞ (ye≈üil) */
  .topcard{
    position:fixed; z-index:1000;
    top:calc(env(safe-area-inset-top,0px) + 8px); left:10px; right:10px;
    background:#0b5a38; color:#fff; border-radius:14px;
    border:1px solid rgba(255,255,255,.08);
    padding:12px 14px; box-shadow:0 10px 30px rgba(0,0,0,.35);
    display:flex; align-items:center; gap:12px;
  }
  .turnicon{font-size:20px; line-height:1}
  .toptext{display:flex; flex-direction:column; gap:2px; min-width:0}
  .toptext b{font-size:16px}
  .toptext small{opacity:.9}
  .mic{margin-left:auto; width:34px; height:34px; border-radius:50%; background:#fff3;
       display:grid; place-items:center; font-size:18px}

  /* ALT Bƒ∞LGƒ∞ √áUBUƒûU (siyah) */
  .bottombar{
    position:fixed; z-index:1000;
    bottom:calc(env(safe-area-inset-bottom,0px) + 8px); left:10px; right:10px;
    background:#0e1117; color:#fff; border-radius:16px; padding:10px 12px;
    border:1px solid #1f2330; box-shadow:0 10px 30px rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:space-between;
  }
  .leftinfo .mins{color:#fbbf24; font-weight:800; font-size:20px}
  .leftinfo .meta{color:#b8c0cc; font-size:14px}
  .exit{background:#dc2626; color:#fff; border:none; padding:8px 14px; border-radius:10px; font-weight:700}

  /* Kenar buton grubu (rota/ba≈ülat vs.) */
  .fabcol{position:fixed; right:10px; bottom:calc(90px + env(safe-area-inset-bottom,0px));
          display:flex; flex-direction:column; gap:10px; z-index:999}
  .fab{
    width:52px; height:52px; border-radius:50%; display:grid; place-items:center;
    background:#12151c; color:#e7e9ee; border:1px solid #1f2330; cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,.4); font-size:20px;
  }
  .fab.primary{background:#3b82f6; border-color:#3b82f6; color:#fff}

  /* Ara√ß oku */
  .veh-wrap{width:26px;height:26px;background:rgba(255,255,255,.85);border-radius:50%;display:grid;place-items:center}
  .veh{
    width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:16px solid #3b82f6
  }
  .pill{position:fixed; left:12px; top:calc(72px + env(safe-area-inset-top,0px)); background:rgba(0,0,0,.45); color:#fff; padding:6px 8px; border-radius:10px; font-size:12px; display:none}
</style>
</head>
<body>

<div id="map" aria-label="Harita"></div>

<!-- √úST (talimat) -->
<div class="topcard">
  <div class="turnicon" id="turnIcon">‚¨ÜÔ∏è</div>
  <div class="toptext">
    <b id="topMain">Y√∂n hesaplanƒ±yor‚Ä¶</b>
    <small id="topSub">Sokak adƒ±</small>
  </div>
  <div class="mic">üé§</div>
</div>

<!-- ALT (kalan s√ºre/mesafe/ETA + √ßƒ±kƒ±≈ü) -->
<div class="bottombar">
  <div class="leftinfo">
    <div class="mins" id="mins">‚Äî dk.</div>
    <div class="meta" id="meta">‚Äî m ¬∑ ‚Äî:‚Äî</div>
  </div>
  <button class="exit" id="btnExit">√áƒ±kƒ±≈ü</button>
</div>

<!-- Saƒü butonlar -->
<div class="fabcol">
  <button class="fab" id="btnLocate" title="Konum">üìç</button>
  <button class="fab" id="btnPick" title="Hedef Se√ß">üéØ</button>
  <button class="fab" id="btnRoute" title="Rota">üß≠</button>
  <button class="fab primary" id="btnStart" title="Ba≈ülat">‚ñ∂</button>
  <button class="fab" id="btnStop" title="Dur">‚è∏</button>
</div>

<div class="pill" id="speedPill">Hƒ±z: 8 m/sn</div>

<script>
/* ============= Ger√ßek sokak rotasƒ± + talimat + ETA ============= */
let map = L.map('map',{zoomControl:false});
L.control.zoom({position:'topright'}).addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);

const turnIcon = document.getElementById('turnIcon');
const topMain  = document.getElementById('topMain');
const topSub   = document.getElementById('topSub');
const minsEl   = document.getElementById('mins');
const metaEl   = document.getElementById('meta');
const speedPill= document.getElementById('speedPill');

function fmtDist(m){ return m<950 ? `${Math.round(m)} m` : `${(m/1000).toFixed(1).replace('.',',')} km`; }
function fmtMin(s){ return `${Math.ceil(s/60)} dk.`; }
function fmtEta(s){ const d=new Date(Date.now()+s*1000); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }
function trManeuver(mod){ const t={
  'right':'saƒüa d√∂n','left':'sola d√∂n','straight':'d√ºz devam et',
  'slight right':'hafif saƒü','slight left':'hafif sol',
  'uturn':'geri d√∂n','sharp right':'keskin saƒü','sharp left':'keskin sol',
  'roundabout':'d√∂ner kav≈üak','fork':'√ßatalla'
}; return t[mod]||'devam et'; }
function emojiFor(mod){ const e={right:'‚Ü±',left:'‚Ü∞','slight right':'‚Üó','slight left':'‚Üñ','sharp right':'‚§¥','sharp left':'‚§µ',straight:'‚¨ÜÔ∏è',uturn:'‚ü≤'}; return e[mod]||'‚¨ÜÔ∏è'; }

const iconStart=L.divIcon({className:'',html:'<div style="width:18px;height:18px;border-radius:50%;background:#f59e0b;border:2px solid #ffe7bf"></div>',iconSize:[18,18],iconAnchor:[9,9]});
const iconDest =L.divIcon({className:'',html:'<div style="width:18px;height:18px;border-radius:50%;background:#22c55e;border:2px solid #d8f9e5"></div>',iconSize:[18,18],iconAnchor:[9,9]});
function vehIcon(angle=0){ return L.divIcon({className:'',html:`<div class="veh-wrap" style="transform:rotate(${angle}deg)"><div class="veh"></div></div>`,iconSize:[26,26],iconAnchor:[13,13]}); }

const DEFAULT_START=[41.03678,28.98556]; // ƒ∞stiklal
const DEFAULT_DEST =[41.02566,28.97438]; // Galata
let startMarker=L.marker(DEFAULT_START,{icon:iconStart,draggable:true}).addTo(map);
let destMarker =L.marker(DEFAULT_DEST ,{icon:iconDest ,draggable:true}).addTo(map);
map.setView(DEFAULT_START,16);

let picking=false, routeLine=null, movingMarker=null, route=[], cumDist=[], totalDist=0,totalDur=0;
let segIndex=0, segT=0, steps=[], stepIndex=0, animId=null, simSpeed=8;

function setTop(cardText,street,mod,remain){
  turnIcon.textContent=emojiFor(mod||'straight');
  topMain.textContent = `${remain?fmtDist(remain)+' sonra ':''}${trManeuver(mod||'straight')}`;
  topSub.textContent  = street||'';
}
function setBottom(remainMeters,remainSec){
  minsEl.textContent = fmtMin(remainSec);
  metaEl.textContent = `${fmtDist(remainMeters)} ¬∑ ${fmtEta(remainSec)}`;
}

async function buildRoute(){
  const A=startMarker.getLatLng(), B=destMarker.getLatLng();
  const url=`https://router.project-osrm.org/route/v1/driving/${A.lng},${A.lat};${B.lng},${B.lat}?overview=full&geometries=geojson&steps=true`;
  topMain.textContent='Rota aranƒ±yor‚Ä¶'; topSub.textContent='';
  const r=await fetch(url); const j=await r.json();
  const R=j.routes?.[0]; if(!R){ topMain.textContent='Rota bulunamadƒ±'; return; }

  steps=R.legs[0]?.steps||[]; totalDist=R.distance; totalDur=R.duration;

  const coords=R.geometry.coordinates; route=coords.map(([lon,lat])=>L.latLng(lat,lon));
  cumDist=[0]; for(let i=1;i<route.length;i++){ cumDist[i]=cumDist[i-1]+map.distance(route[i-1],route[i]); }

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(route,{color:'#3b82f6',weight:7,opacity:.9}).addTo(map);
  map.fitBounds(routeLine.getBounds(),{padding:[70,70]});

  if(movingMarker) map.removeLayer(movingMarker);
  movingMarker=L.marker(route[0],{icon:vehIcon(0)}).addTo(map);

  segIndex=0; segT=0; stepIndex=0;
  const firstStep=steps[0]||{};
  setTop(null, firstStep.name, firstStep.maneuver?.modifier, 0);
  setBottom(totalDist,totalDur);
}

function currentProgressMeters(i,t){
  if(!cumDist.length) return 0;
  const segStart=cumDist[i]||0; const segEnd=cumDist[i+1]||segStart;
  return segStart+(segEnd-segStart)*t;
}
function bearing(a,b){
  const œÜ1=a.lat*Math.PI/180, œÜ2=b.lat*Math.PI/180, ŒîŒª=(b.lng-a.lng)*Math.PI/180;
  const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}
function stepToNext(){
  if(!route.length){ cancelAnimationFrame(animId); animId=null; return; }
  if(segIndex>=route.length-1){ cancelAnimationFrame(animId); animId=null; setTop('Varƒ±≈ü','','',0); setBottom(0,0); return; }

  const A=route[segIndex], B=route[segIndex+1];
  const d=Math.max(1,map.distance(A,B));
  const step = simSpeed*(1/30); // ~30fps
  segT += step/d;

  if(segT>=1){ segIndex++; segT=0; if(stepIndex<steps.length-1) stepIndex++; }

  const lat=A.lat+(B.lat-A.lat)*segT, lng=A.lng+(B.lng-A.lng)*segT;
  const pos=L.latLng(lat,lng);
  movingMarker.setLatLng(pos); movingMarker.setIcon(vehIcon(bearing(A,B)));
  map.panTo(pos,{animate:false});

  const prog=currentProgressMeters(segIndex,segT);
  const remainM=Math.max(0,totalDist-prog);
  const remainS = totalDist? totalDur*(remainM/totalDist):0;

  // sƒ±radaki manevraya uzaklƒ±k
  const s=steps[Math.min(stepIndex,steps.length-1)]||{};
  const [mlon,mlat]=s.maneuver?.location||[pos.lng,pos.lat];
  const tillTurn = map.distance(pos,L.latLng(mlat,mlon));
  setTop(null, s.name, s.maneuver?.modifier, tillTurn);
  setBottom(remainM, remainS);

  animId=requestAnimationFrame(stepToNext);
}

/* Etkile≈üimler */
document.getElementById('btnLocate').onclick=()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(ok=>{
      const c=[ok.coords.latitude,ok.coords.longitude];
      startMarker.setLatLng(c); map.setView(c,16);
    },()=>{}, {enableHighAccuracy:true,timeout:5000});
  }
};
document.getElementById('btnPick').onclick=()=>{
  const h = e=>{ destMarker.setLatLng(e.latlng); map.off('click',h); };
  map.once('click',h);
};
document.getElementById('btnRoute').onclick=buildRoute;
document.getElementById('btnStart').onclick=()=>{ if(!animId) animId=requestAnimationFrame(stepToNext); };
document.getElementById('btnStop').onclick =()=>{ if(animId){ cancelAnimationFrame(animId); animId=null; } };
document.getElementById('btnExit').onclick =()=>{ history.back(); };

// hƒ±z ayarƒ± (saƒüa kaydƒ±r: daha hƒ±zlƒ±)
let lastX=null;
map.on('touchstart',e=>{ lastX = e.originalEvent.touches?.[0]?.clientX??null; });
map.on('touchmove',e=>{
  if(lastX==null) return;
  const x=e.originalEvent.touches?.[0]?.clientX??lastX;
  const dx=x-lastX;
  if(Math.abs(dx)>20){
    simSpeed = Math.min(25, Math.max(3, simSpeed + (dx>0?1:-1)));
    speedPill.textContent = `Hƒ±z: ${simSpeed} m/sn`;
    speedPill.style.display='block';
    setTimeout(()=> speedPill.style.display='none', 700);
    lastX = x;
  }
});

buildRoute(); // varsayƒ±lan ƒ∞stiklal ‚Üí Galata
</script>
</body>
</html>

<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Harita — Sokak Rotası Sim (ETA + Talimat)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg:#0f1115; --paper:#12151c; --ink:#e7e9ee; --muted:#9aa3af;
  --accent:#3b82f6; --border:#1f2330; --soft:#181c25;
  --topbar-h:64px; --bottombar-h:78px;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font:15px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,sans-serif;
  padding-top:calc(var(--topbar-h) + env(safe-area-inset-top,0px));
  padding-top:calc(var(--topbar-h) + constant(safe-area-inset-top,0px));
  padding-bottom:calc(var(--bottombar-h) + env(safe-area-inset-bottom,0px));
  padding-bottom:calc(var(--bottombar-h) + constant(safe-area-inset-bottom,0px));
}

/* ÜST BAR */
.topbar{
  position:fixed; z-index:50; top:0; left:0; right:0;
  height:calc(var(--topbar-h) + env(safe-area-inset-top,0px));
  height:calc(var(--topbar-h) + constant(safe-area-inset-top,0px));
  padding-top:env(safe-area-inset-top,0px);
  padding-top:constant(safe-area-inset-top,0px);
  background:#0e121b; border-bottom:1px solid var(--border);
  display:flex; align-items:flex-end;
}
.row{
  height:var(--topbar-h); width:100%; max-width:860px; margin:0 auto;
  display:flex; align-items:center; justify-content:space-between; padding:0 16px
}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; font-size:18px}
.brand .logo{height:26px; width:auto}
.status{color:var(--muted); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:40%}
.eta{color:var(--ink); font-size:13px; text-align:right}
.eta small{color:var(--muted); display:block}

/* ALT BAR */
.bottombar{
  position:fixed; z-index:40;
  bottom:calc(env(safe-area-inset-bottom,0px) + 8px);
  bottom:calc(constant(safe-area-inset-bottom,0px) + 8px);
  left:10px; right:10px; height:58px; border-radius:14px;
  background:var(--paper); border:1px solid var(--border);
  display:flex; align-items:center; gap:10px; padding:0 10px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.bottombar .btn{
  appearance:none; border:1px solid var(--border); background:var(--soft);
  color:var(--ink); padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
}
.bottombar .btn.primary{background:var(--accent); border-color:var(--accent); color:#fff}
.bottombar .right{margin-left:auto; display:flex; align-items:center; gap:10px; color:var(--muted)}
.range{accent-color:var(--accent)}
label.small{font-size:12px; color:var(--muted)}

/* HARİTA */
#map{position:fixed; inset:calc(var(--topbar-h) + env(safe-area-inset-top,0px)) 0 calc(var(--bottombar-h) + 8px + env(safe-area-inset-bottom,0px)) 0}
.leaflet-container{background:#0b0e14}

/* Marker stilleri */
.dest{width:18px;height:18px;background:#22c55e;border:2px solid #e6f9ed;border-radius:50%}
.start{width:18px;height:18px;background:#f59e0b;border:2px solid #fff2d6;border-radius:50%}

/* “ok” simüle konum */
.heading-pin{
  width:22px; height:22px; border-radius:50%;
  border:2px solid #cbe1ff; background:#3b82f6;
  box-shadow:0 0 0 2px rgba(59,130,246,.25);
}
.heading-arrow{
  position:absolute; top:-8px; left:50%;
  width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent;
  border-bottom:10px solid #3b82f6; transform:translateX(-50%);
}

/* Talimat / info pill */
.pill{
  position:fixed; left:12px; top:calc(var(--topbar-h) + env(safe-area-inset-top,0px) + 12px);
  background:rgba(18,21,28,.92); border:1px solid var(--border); color:var(--ink);
  padding:10px 12px; border-radius:12px; font-size:13px; max-width:70%;
  box-shadow:0 10px 24px rgba(0,0,0,.3);
}
.pill b{font-weight:800}
.pill .road{color:var(--muted)}
.pill .dist{margin-left:6px; color:#cde0ff}

/* küçük legend (opsiyonel) */
.legend{
  position:fixed; right:12px; top:calc(var(--topbar-h) + env(safe-area-inset-top,0px) + 12px);
  background:rgba(18,21,28,.9); border:1px solid var(--border); color:var(--ink);
  padding:8px 10px; border-radius:10px; font-size:12px
}
</style>
</head>
<body>

<!-- ÜST BAR -->
<header class="topbar">
  <div class="row">
    <div class="brand">
      <img class="logo" src="https://dummyimage.com/60x26/ffffff/000000&text=M" alt="">
      Harita
    </div>
    <div class="status" id="status">Konum bekleniyor…</div>
    <div class="eta" id="etaBox">
      <div id="etaTime">ETA —</div>
      <small id="etaRemain">Kalan —</small>
    </div>
  </div>
</header>

<!-- HARİTA -->
<div id="map" aria-label="harita"></div>
<div class="pill" id="pill" style="display:none"></div>
<div class="legend">Turuncu: Başlangıç • Yeşil: Hedef • Mavi: Rota</div>

<!-- ALT BAR -->
<nav class="bottombar">
  <button id="btnLocate" class="btn">Konum</button>
  <button id="btnPick" class="btn">Hedef Seç</button>
  <button id="btnRoute" class="btn">Rota</button>
  <button id="btnStart" class="btn primary">Başlat</button>
  <button id="btnStop" class="btn">Durdur</button>
  <button id="btnReset" class="btn">Sıfırla</button>
  <div class="right">
    <label class="small">Takip
      <input type="checkbox" id="chkFollow" checked>
    </label>
    <label class="small">Hız
      <input type="range" id="rangeSpeed" class="range" min="3" max="25" step="1" value="8">
    </label>
  </div>
</nav>

<script>
/* ====== Rota + adım adım talimat + ETA ====== */
let map, startMarker, destMarker, movingMarker, routeLine, picking=false;
let animId=null, route=[], cumDist=[], routeLen=0, segIndex=0, segT=0; // polyline animasyonu
let follow=true, steps=[], stepIndex=0;
let totalDist=0, totalDur=0; // OSRM toplam mesafe (m) ve süre (sn)

const statusEl = document.getElementById('status');
const pillEl   = document.getElementById('pill');
const etaTimeEl= document.getElementById('etaTime');
const etaRemEl = document.getElementById('etaRemain');
const speedEl  = document.getElementById('rangeSpeed');
const chkFollow= document.getElementById('chkFollow');

function setStatus(m){ statusEl.textContent=m; }
function fmtDist(m){
  if(m < 950) return `${Math.round(m)} m`;
  return (m/1000).toFixed(1).replace('.',',') + ' km';
}
function fmtMin(sec){
  const m = Math.ceil(sec/60);
  return `${m} dk`;
}
function fmtTimeFromNow(sec){
  const d = new Date(Date.now() + sec*1000);
  const hh = d.getHours().toString().padStart(2,'0');
  const mm = d.getMinutes().toString().padStart(2,'0');
  return `${hh}:${mm}`;
}
function trManeuver(mod){
  const map = {
    'right':'sağa dön', 'left':'sola dön', 'straight':'düz devam et',
    'slight right':'hafif sağ', 'slight left':'hafif sol',
    'uturn':'geri dön', 'sharp right':'keskin sağ', 'sharp left':'keskin sol',
    'roundabout':'döner kavşak', 'fork':'çatalla'
  };
  return map[mod] || 'devam et';
}

/* Harita */
map = L.map('map', { zoomControl:false });
L.control.zoom({ position:'topright' }).addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 20, attribution: '© OpenStreetMap'
}).addTo(map);

/* Icon helpers */
function makeDivIcon(html){ return L.divIcon({ className:'', html, iconSize:[22,22], iconAnchor:[11,11] }); }
const iconStart = L.divIcon({className:'start', iconSize:[18,18]});
const iconDest  = L.divIcon({className:'dest',  iconSize:[18,18]});
function headingIcon(angleDeg=0){
  const el = `<div class="heading-pin" style="transform:rotate(${angleDeg}deg)">
      <div class="heading-arrow"></div></div>`;
  return makeDivIcon(el);
}

/* Varsayılan: İstiklal -> Galata */
const DEFAULT_START = [41.03678, 28.98556];
const DEFAULT_DEST  = [41.02566, 28.97438];
placeStart(DEFAULT_START); map.setView(DEFAULT_START, 16);
placeDest(DEFAULT_DEST);

/* Konum */
function locate(){
  setStatus('Konum alınıyor…');
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(ok=>{
      const c=[ok.coords.latitude, ok.coords.longitude];
      placeStart(c); map.setView(c, 16); setStatus('Konum hazır');
    }, _=>{
      setStatus('Konum izni yok — varsayılan kullanılıyor');
    }, {enableHighAccuracy:true, timeout:5000});
  }else{
    setStatus('Geolocation yok — varsayılan kullanılıyor');
  }
}

/* Yerleştiriciler */
function placeStart(latlng){
  if(startMarker) map.removeLayer(startMarker);
  startMarker = L.marker(latlng, {icon:iconStart, draggable:true}).addTo(map);
  startMarker.on('dragend', ()=> { setStatus('Başlangıç taşındı'); });
}
function placeDest(latlng){
  if(destMarker) map.removeLayer(destMarker);
  destMarker = L.marker(latlng, {icon:iconDest, draggable:true}).addTo(map);
  destMarker.on('dragend', ()=> { setStatus('Hedef taşındı'); });
}

/* OSRM rota */
async function buildRouteOSRM(){
  if(!startMarker || !destMarker){ setStatus('Başlangıç ve hedef gerekli'); return; }
  const A = startMarker.getLatLng(), B = destMarker.getLatLng();
  const url = `https://router.project-osrm.org/route/v1/driving/${A.lng},${A.lat};${B.lng},${B.lat}?overview=full&geometries=geojson&steps=true`;
  setStatus('Rota aranıyor…');
  try{
    const r = await fetch(url); const j = await r.json();
    if(!j.routes?.length){ setStatus('Rota bulunamadı'); return; }
    const R = j.routes[0];
    totalDist = R.distance;      // metre
    totalDur  = R.duration;      // saniye (OSRM)
    steps = (R.legs[0]?.steps) || [];

    // polyline
    const coords = R.geometry.coordinates; // [lon,lat]
    route = coords.map(([lon,lat])=> L.latLng(lat,lon));
    // kümülatif mesafe hesabı
    cumDist = [0];
    for(let i=1;i<route.length;i++){
      const d = map.distance(route[i-1], route[i]);
      cumDist[i] = cumDist[i-1] + d;
    }

    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(route, {color:'#3b82f6', weight:5, opacity:0.85}).addTo(map);
    map.fitBounds(routeLine.getBounds(), {padding:[60,60]});

    if(movingMarker) map.removeLayer(movingMarker);
    movingMarker = L.marker(route[0], {icon:headingIcon(0)}).addTo(map);

    routeLen = route.length; segIndex=0; segT=0; stepIndex=0;

    // ETA ilk hesap
    updateETA(0);

    setStatus('Rota hazır — Başlat’a bas');
    showInstruction(0); // ilk talimat
  }catch(e){
    console.error(e); setStatus('Rota servisine erişilemedi');
  }
}

/* Talimat gösterme */
function showInstruction(progressMeters){
  if(!steps.length){ pillEl.style.display='none'; return; }
  // ilerlemeye göre hangi steptayız? basit yaklaşım: stepIndex'i koruyoruz.
  const s = steps[Math.min(stepIndex, steps.length-1)];
  const name = s.name || 'yol';
  const mod  = (s.maneuver?.modifier) || (s.maneuver?.type) || 'straight';
  const text = trManeuver(mod);

  // bir sonraki manevra noktasına kalan mesafe
  const [lon,lat] = s.maneuver.location || [route[route.length-1].lng, route[route.length-1].lat];
  const mPos = movingMarker.getLatLng();
  const remainToTurn = map.distance(mPos, L.latLng(lat,lon));

  pillEl.innerHTML = `<b>${text}</b> · <span class="road">${name}</span>
                      <span class="dist">· ${fmtDist(remainToTurn)} sonra</span>`;
  pillEl.style.display='block';
}

/* ETA/Kalan süre güncelleme — OSRM toplam süreyi mesafeye orantılı dağıtıyoruz */
function updateETA(progressMeters){
  const remain = Math.max(0, totalDist - progressMeters);        // m
  const remainSec = (totalDist>0) ? totalDur * (remain/totalDist) : 0; // s
  etaTimeEl.textContent = `ETA ${fmtTimeFromNow(remainSec)}`;
  etaRemEl.textContent  = `Kalan ${fmtMin(remainSec)}`;
}

/* Yardımcılar */
function dist(a,b){ return map.distance(a,b); }
function bearing(a,b){
  const φ1=a.lat*Math.PI/180, φ2=b.lat*Math.PI/180;
  const Δλ=(b.lng-a.lng)*Math.PI/180;
  const y=Math.sin(Δλ)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  let θ=Math.atan2(y,x)*180/Math.PI;
  return (θ+360)%360;
}

/* Animasyon (rota noktaları arasında) */
function currentProgressMeters(i, t){
  // i: segment index, t: 0..1
  if(i<=0) return cumDist[0] + (cumDist[1]??0)*t;
  const segStart = cumDist[i];
  const segLen   = (cumDist[i+1]??cumDist[i]) - segStart;
  return segStart + segLen * t;
}

function stepToNext(){
  const v = Number(speedEl.value); // sim hız ~ m/s
  let i = segIndex, t = segT;

  if(i >= routeLen-1){ stop(); setStatus('Varış'); pillEl.style.display='none'; updateETA(totalDist); return; }

  const A = route[i], B = route[i+1];
  const d = Math.max(1, dist(A,B));       // metre
  const step = v * (1/30);                // ~30fps
  const u = step/d;
  t += u;

  if(t >= 1){
    segIndex++; t = 0;
    // manevra adımı artır (yaklaşık): dönemeç sayacını ilerlet
    if(stepIndex < steps.length-1) stepIndex++;
  }

  // yeni konum
  const lat = A.lat + (B.lat - A.lat) * t;
  const lng = A.lng + (B.lng - A.lng) * t;
  const pos = L.latLng(lat,lng);
  movingMarker.setLatLng(pos);
  movingMarker.setIcon(headingIcon(bearing(A,B)));

  if(follow) map.panTo(pos, {animate:false});

  // İlerleme (metre), ETA & talimat güncelle
  const prog = currentProgressMeters(segIndex, t);
  updateETA(prog);
  showInstruction(prog);

  setStatus(`İlerliyor · hız ~${v} m/sn`);
  segT = t;
  animId = requestAnimationFrame(stepToNext);
}

function start(){
  if(!routeLen){ setStatus('Önce Rota yap'); return; }
  if(animId) cancelAnimationFrame(animId);
  animId = requestAnimationFrame(stepToNext);
}
function stop(){
  if(animId){ cancelAnimationFrame(animId); animId=null; setStatus('Duraklatıldı'); }
}
function resetAll(){
  stop();
  [startMarker,destMarker,movingMarker,routeLine].forEach(m=> m && map.removeLayer(m));
  startMarker=destMarker=movingMarker=routeLine=null;
  route=[]; cumDist=[]; routeLen=0; segIndex=0; segT=0; steps=[]; stepIndex=0;
  totalDist=0; totalDur=0;
  placeStart(DEFAULT_START); placeDest(DEFAULT_DEST);
  map.setView(DEFAULT_START, 16);
  setStatus('Sıfırlandı — Konum al veya Hedef seç');
  pillEl.style.display='none';
  etaTimeEl.textContent = 'ETA —'; etaRemEl.textContent='Kalan —';
}

/* Etkileşimler */
document.getElementById('btnLocate').onclick = locate;
document.getElementById('btnPick').onclick = ()=>{
  picking = !picking;
  setStatus(picking?'Haritaya dokun: hedef koy':'Hedef seçme kapalı');
  document.getElementById('btnPick').classList.toggle('primary', picking);
};
map.on('click', e=>{
  if(!picking) return;
  placeDest(e.latlng);
  picking=false;
  document.getElementById('btnPick').classList.remove('primary');
  setStatus('Hedef ayarlandı — Rota’ya bas');
});
document.getElementById('btnRoute').onclick = buildRouteOSRM;
document.getElementById('btnStart').onclick = start;
document.getElementById('btnStop').onclick  = stop;
document.getElementById('btnReset').onclick = resetAll;
chkFollow.onchange = ()=> { follow = chkFollow.checked; };

/* Başlangıç durumu */
setStatus('Başlangıç ve hedef hazır (İstiklal → Galata). “Rota”, sonra “Başlat”.');
</script>
</body>
</html>
